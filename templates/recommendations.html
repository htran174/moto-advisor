{% extends "base.html" %}
{% block content %}
<section class="card" style="width:100%; max-width:1200px; overflow:hidden;">
  <!-- Header with horizontal tabs -->
  <div class="section-pad" style="background: linear-gradient(180deg, #F3F4F6, #FFFFFF); border-bottom:1px solid var(--border);">
    <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
      <h2 class="title" style="margin-right:auto;">Recommendations & Chat</h2>
      <nav aria-label="Tabs" class="tabs" style="display:flex; gap:.25rem; background:var(--surface); border:1px solid var(--border); border-radius:999px; padding:.25rem;">
        <button id="tabRecs" class="tab active" type="button" aria-selected="true"
                style="border:none; background:var(--primary); color:#fff; padding:.5rem 1rem; border-radius:999px; font-weight:600;">
          Recommendations
        </button>
        <button id="tabChat" class="tab" type="button" aria-selected="false"
                style="border:none; background:transparent; color:var(--text); padding:.5rem 1rem; border-radius:999px; font-weight:600;">
          Chat
        </button>
      </nav>
    </div>
    <p id="meta" class="subtitle" style="margin:.25rem 0 0;">Loadingâ€¦</p>
  </div>

  <!-- Content -->
  <div class="section-pad" style="padding-top:1rem;">
    <!-- Panel: Recommendations -->
    <div id="panelRecs">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem; margin-bottom:.75rem;">
        <div class="subtitle" id="profileSummary"></div>
        <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <a href="{{ url_for('advisor') }}" class="btn btn-outline" style="text-decoration:none;">Edit inputs</a>
          <button id="btnReRun" class="btn btn-primary" type="button">Re-run</button>
          <button id="btnClearHistory" class="btn btn-outline" type="button">Clear history</button>
        </div>
      </div>

      <!-- Visible, de-duplicated list -->
      <div id="visibleList" class="grid" style="gap:1rem;"></div>

      <!-- Full timeline (expandable) -->
      <details style="margin-top:1rem;">
        <summary class="subtitle">Show full timeline snapshots</summary>
        <div id="timeline" class="grid" style="gap:1rem; margin-top:.75rem;"></div>
      </details>
    </div>

    <!-- Panel: Chat -->
    <div id="panelChat" hidden>
      <div class="card" style="border:1px solid var(--border); overflow:hidden;">
        <div class="section-pad" style="background: linear-gradient(180deg, #F3F4F6, #FFFFFF); border-bottom:1px solid var(--border);">
          <p class="subtitle" style="margin:0;">
            Hi I'm an ai agent that will help you look for your new bike! Feel free to tell me what your looking for!
            <code></code>
          </p>
        </div>

        <div id="chatBody" style="padding: 1rem; height: 340px; overflow:auto; background: var(--surface-2);">
          <div class="bubble bot">
            <p>Hi! I can update your profile and refresh suggestions. Use the tabs to view cards or stay here to chat.</p>
            <time></time>
          </div>
        </div>

        <form id="chatForm" class="section-pad" style="display:flex; gap:.5rem; border-top:1px solid var(--border); background: var(--surface);">
          <label for="chatInput" class="sr-only">Enter your message</label>
          <input id="chatInput" type="text" placeholder="Type naturally (e.g., 'show cruisers under 7k')"
                 style="flex:1; padding:.85rem 1rem; border:1px solid var(--border); border-radius: 999px; background:#fff;">
          <button class="btn btn-primary" type="submit">Send</button>
        </form>
      </div>
    </div>
  </div>
</section>

<!-- Backdrop + Modals (unchanged) -->
<div id="modalBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000;"></div>

<div id="absModal" class="card" style="display:none; position:fixed; z-index:1001; left:50%; top:20%; transform:translateX(-50%); width:min(520px, 92vw); border:1px solid var(--border);">
  <div class="section-pad" style="border-bottom:1px solid var(--border); background:linear-gradient(180deg,#F3F4F6,#FFFFFF);">
    <strong>Safety notice</strong>
  </div>
  <div class="section-pad" style="line-height:1.7;">
    Some recommended bikes in this list do <strong>not</strong> include ABS. Consider choosing a trim with ABS if available.
  </div>
  <div class="section-pad" style="display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid var(--border);">
    <button id="absOk" class="btn btn-primary" type="button">OK</button>
  </div>
</div>

<div id="msrpModal" class="card" style="display:none; position:fixed; z-index:1001; left:50%; top:20%; transform:translateX(-50%); width:min(560px, 92vw); border:1px solid var(--border);">
  <div class="section-pad" style="border-bottom:1px solid var(--border); background:linear-gradient(180deg,#F3F4F6,#FFFFFF);">
    <strong>Heads-up on pricing</strong>
  </div>
  <div class="section-pad" style="line-height:1.7;">
    Manufacturer pages often show <strong>MSRP</strong>. For first bikes, many riders consider <strong>second-hand</strong> options.
  </div>
  <div class="section-pad" style="display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid var(--border);">
    <button id="msrpCancel" class="btn btn-outline" type="button">Cancel</button>
    <button id="msrpProceed" class="btn btn-primary" type="button">Continue to site</button>
  </div>
</div>

<style>
  @media (min-width: 980px){
    #visibleList{ grid-template-columns: repeat(2, minmax(0, 1fr)); display:grid; }
    #timeline{ grid-template-columns: repeat(2, minmax(0, 1fr)); display:grid; }
  }
  .bubble{
    max-width: 76%;
    padding: .75rem 1rem;
    margin: .35rem 0;
    border-radius: 18px;
    line-height: 1.45;
    box-shadow: 0 2px 10px rgba(0,0,0,.05);
    word-wrap: break-word;
  }
  .bubble time{ display:block; font-size:.75rem; color: var(--muted); margin-top:.35rem; }
  .bubble.user{ margin-left:auto; background: linear-gradient(90deg, var(--primary), var(--primary-600)); color:#fff; border-bottom-right-radius:6px; }
  .bubble.bot{ background:#fff; border:1px solid var(--border); color:var(--text); border-bottom-left-radius:6px; }
  .skeleton{
    border:1px solid var(--border); border-radius: var(--radius); overflow:hidden;
    background: linear-gradient(90deg, #eee, #f7f7f7, #eee); background-size:200% 100%; animation: shimmer 1.4s infinite; height: 220px;
  }
  @keyframes shimmer{ 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }
  .chip{ display:inline-block; font-size:.8rem; padding:.15rem .5rem; border-radius:999px; border:1px solid var(--border); background:#fff; }
  .chip.warn{ border-color:#f59e0b; background:#fff7ed; }
</style>

<script src="{{ url_for('static', filename='js/recommendations.js') }}" defer></script>
{% endblock %}
