{% extends "base.html" %}
{% block content %}
<section class="card" style="width:100%; max-width:1200px; overflow:hidden;">
  <!-- Header with horizontal tabs -->
  <div class="section-pad" style="background: linear-gradient(180deg, #F3F4F6, #FFFFFF); border-bottom:1px solid var(--border);">
    <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
      <h2 class="title" style="margin-right:auto;">Your Recommendations</h2>
      <nav aria-label="Tabs" class="tabs" style="display:flex; gap:.25rem; background:var(--surface); border:1px solid var(--border); border-radius:999px; padding:.25rem;">
        <button id="tabRecs" class="tab active" type="button" aria-selected="true"
                style="border:none; background:var(--primary); color:#fff; padding:.5rem 1rem; border-radius:999px; font-weight:600;">
          Recommendations
        </button>
        <button id="tabChat" class="tab" type="button" aria-selected="false"
                style="border:none; background:transparent; color:var(--text); padding:.5rem 1rem; border-radius:999px; font-weight:600;">
          Chat
        </button>
      </nav>
    </div>
    <p id="meta" class="subtitle" style="margin:.25rem 0 0;">Loading…</p>
  </div>

  <!-- Content -->
  <div class="section-pad" style="padding-top:1rem;">
    <!-- Panel: Recommendations -->
    <div id="panelRecs">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem; margin-bottom:.75rem;">
        <div class="subtitle" id="profileSummary"></div>
        <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <a href="{{ url_for('advisor') }}" class="btn btn-outline" style="text-decoration:none;">Edit inputs</a>
          <button id="btnReRun" class="btn btn-primary" type="button">Re-run</button>
          <button id="btnClearHistory" class="btn btn-outline" type="button">Clear history</button>
        </div>
      </div>

      <!-- Visible, de-duplicated list -->
      <div id="visibleList" class="grid" style="gap:1rem;"></div>

      <!-- Full timeline (expandable) -->
      <details style="margin-top:1rem;">
        <summary class="subtitle">Show full timeline snapshots</summary>
        <div id="timeline" class="grid" style="gap:1rem; margin-top:.75rem;"></div>
      </details>
    </div>

    <!-- Panel: Chat -->
    <div id="panelChat" hidden>
      <div class="card" style="border:1px solid var(--border); overflow:hidden;">
        <div class="section-pad" style="background: linear-gradient(180deg, #F3F4F6, #FFFFFF); border-bottom:1px solid var(--border);">
          <p class="subtitle" style="margin:0;">Prototype chat<code>height: 175cm budget: 7000 types: naked, sportbike</code></p>
        </div>

        <div id="chatBody" style="padding: 1rem; height: 340px; overflow:auto; background: var(--surface-2);">
          <div class="bubble bot">
            <p>Hi! I can adjust your profile and refresh suggestions. <code> You can go back to see the recommendation by the recommendation tab</code>.</p>
            <time></time>
          </div>
        </div>

        <form id="chatForm" class="section-pad" style="display:flex; gap:.5rem; border-top:1px solid var(--border); background: var(--surface);">
          <label for="chatInput" class="sr-only">Enter your message</label>
          <input id="chatInput" type="text" placeholder="Type /set … or /rec"
                 style="flex:1; padding:.85rem 1rem; border:1px solid var(--border); border-radius: 999px; background:#fff;">
          <button class="btn btn-primary" type="submit">Send</button>
        </form>
      </div>
    </div>
  </div>
</section>

<!-- Modals -->
<div id="modalBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000;"></div>

<!-- ABS modal -->
<div id="absModal" class="card" style="display:none; position:fixed; z-index:1001; left:50%; top:20%; transform:translateX(-50%); width:min(520px, 92vw); border:1px solid var(--border);">
  <div class="section-pad" style="border-bottom:1px solid var(--border); background:linear-gradient(180deg,#F3F4F6,#FFFFFF);">
    <strong>Safety notice</strong>
  </div>
  <div class="section-pad" style="line-height:1.7;">
    Some recommended bikes in this list do <strong>not</strong> include ABS. ABS can reduce crash risk in emergency braking.
    Consider choosing a trim with ABS if available.
  </div>
  <div class="section-pad" style="display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid var(--border);">
    <button id="absOk" class="btn btn-primary" type="button">OK</button>
  </div>
</div>

<!-- MSRP modal (shown on first click to an Official link) -->
<div id="msrpModal" class="card" style="display:none; position:fixed; z-index:1001; left:50%; top:20%; transform:translateX(-50%); width:min(560px, 92vw); border:1px solid var(--border);">
  <div class="section-pad" style="border-bottom:1px solid var(--border); background:linear-gradient(180deg,#F3F4F6,#FFFFFF);">
    <strong>Heads-up on pricing</strong>
  </div>
  <div class="section-pad" style="line-height:1.7;">
    Prices shown on manufacturer sites are typically <strong>MSRP</strong>. For a first bike, many riders choose
    <strong>second-hand</strong> to save money since beginners often upgrade quickly or decide riding isn’t for them.
  </div>
  <div class="section-pad" style="display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid var(--border);">
    <button id="msrpCancel" class="btn btn-outline" type="button">Cancel</button>
    <button id="msrpProceed" class="btn btn-primary" type="button">Continue to site</button>
  </div>
</div>

<style>
  @media (min-width: 980px){
    #visibleList{ grid-template-columns: repeat(2, minmax(0, 1fr)); display:grid; }
    #timeline{ grid-template-columns: repeat(2, minmax(0, 1fr)); display:grid; }
  }
  .bubble{
    max-width: 76%;
    padding: .75rem 1rem;
    margin: .35rem 0;
    border-radius: 18px;
    line-height: 1.45;
    box-shadow: 0 2px 10px rgba(0,0,0,.05);
    word-wrap: break-word;
  }
  .bubble time{ display:block; font-size:.75rem; color: var(--muted); margin-top:.35rem; }
  .bubble.user{ margin-left:auto; background: linear-gradient(90deg, var(--primary), var(--primary-600)); color:#fff; border-bottom-right-radius:6px; }
  .bubble.bot{ background:#fff; border:1px solid var(--border); color:var(--text); border-bottom-left-radius:6px; }
  .skeleton{
    border:1px solid var(--border); border-radius: var(--radius); overflow:hidden;
    background: linear-gradient(90deg, #eee, #f7f7f7, #eee); background-size:200% 100%; animation: shimmer 1.4s infinite; height: 220px;
  }
  @keyframes shimmer{ 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }
  .chip{ display:inline-block; font-size:.8rem; padding:.15rem .5rem; border-radius:999px; border:1px solid var(--border); background:#fff; }
  .chip.warn{ border-color:#f59e0b; background:#fff7ed; }
</style>

<script>
(function(){
  // --------- State (session) ---------
  let profile = readJSON('rr.profile') || {experience:'no_experience',height_cm:170,budget_usd:6000,bike_types:[],riding_style:[],k:3};
  let history = readJSON('rr.history') || []; // array of snapshots {id, created_at, profile_used, items[]}
  let hasRunOnce = history.length > 0;

  // Common style sets (IDs you keep in your whitelist)
  const STYLE_COMMON = {
    sportbike: ["yamaha_r3","honda_cbr300r","kawasaki_ninja_400","suzuki_gsxr250"],
    naked:     ["yamaha_mt03","kawasaki_z400","ktm_390_duke","honda_cb300r"],
    cruiser:   ["honda_rebel_300","kawasaki_vulcan_s"],
    standard:  ["honda_cb300r","kawasaki_z400","yamaha_mt03"],
    adventure: ["kawasaki_versys_x_300","honda_cb500x_light"],  // placeholder ids if present
    touring:   ["kawasaki_versys_x_300"],                       // light-safe picks only
    dual_sport:["honda_crf300l"]                                 // light-safe pick
  };
  const GLOBAL_COMMON = ["yamaha_r3","honda_cbr300r","kawasaki_ninja_400","honda_rebel_300","yamaha_mt03","kawasaki_z400","honda_cb300r"];

  // --------- DOM refs ---------
  const meta = document.getElementById('meta');
  const profileSummary = document.getElementById('profileSummary');
  const btnReRun = document.getElementById('btnReRun');
  const btnClearHistory = document.getElementById('btnClearHistory');

  const tabRecs = document.getElementById('tabRecs');
  const tabChat = document.getElementById('tabChat');
  const panelRecs = document.getElementById('panelRecs');
  const panelChat = document.getElementById('panelChat');

  const visibleList = document.getElementById('visibleList');
  const timeline = document.getElementById('timeline');

  const chatBody = document.getElementById('chatBody');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');

  // Modals
  const backdrop = document.getElementById('modalBackdrop');
  const absModal = document.getElementById('absModal'); const absOk = document.getElementById('absOk');
  const msrpModal = document.getElementById('msrpModal'); const msrpCancel = document.getElementById('msrpCancel'); const msrpProceed = document.getElementById('msrpProceed');
  let pendingOfficialHref = null;

  // --------- Tabs behavior ---------
  tabRecs.addEventListener('click', () => switchTab('recs'));
  tabChat.addEventListener('click', () => switchTab('chat'));
  function switchTab(which){
    const recs = which === 'recs';
    panelRecs.hidden = !recs;
    panelChat.hidden = recs;
    tabRecs.classList.toggle('active', recs);
    tabChat.classList.toggle('active', !recs);
    tabRecs.style.background = recs ? 'var(--primary)' : 'transparent';
    tabRecs.style.color = recs ? '#fff' : 'var(--text)';
    tabChat.style.background = !recs ? 'var(--primary)' : 'transparent';
    tabChat.style.color = !recs ? '#fff' : 'var(--text)';
  }

  // --------- Utilities ---------
  function readJSON(k){ try{ return JSON.parse(sessionStorage.getItem(k) || ''); }catch{ return null; } }
  function writeJSON(k,v){ sessionStorage.setItem(k, JSON.stringify(v)); }
  function ts(){ return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  function nowISO(){ return new Date().toISOString(); }
  function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n||min)); }
  function summarize(p){
    const t = (p.bike_types && p.bike_types.length) ? p.bike_types.join(', ') : 'any';
    return `H:${p.height_cm}cm • Budget:$${p.budget_usd} • ${p.experience==='no_experience'?'No exp':'Little exp'} • Types:${t}`;
  }
  function setSkeletons(n){
    visibleList.innerHTML = '';
    for(let i=0;i<n;i++){ const sk=document.createElement('div'); sk.className='skeleton'; visibleList.appendChild(sk); }
  }

  // --------- Rendering ---------
  function perfLine(item){
    const top = (item.max_speed_mph!=null && item.max_speed_mph!==undefined) ? item.max_speed_mph : '-';
    const zero = (item.zero_to_sixty_s!=null && item.zero_to_sixty_s!==undefined) ? item.zero_to_sixty_s : '-';
    return `Top speed — ${top} mph • 0–60 — ${zero} s`;
  }

  function card(item){
    const div = document.createElement('div');
    div.className = 'card';
    div.style.overflow = 'hidden';
    div.style.border = '1px solid var(--border)';
    // Official link click interceptor for MSRP popup
    const officialLinkId = `off_${(item.id||item.name).replace(/[^a-z0-9_]/gi,'')}_${Math.random().toString(36).slice(2)}`;
    div.innerHTML = `
      <div style="height:160px; background:#f5f5f5;">
        <img src="${esc(item.image_url || '/static/motorcyle_ride.jpg')}" alt="${esc(item.name)}"
             style="width:100%; height:160px; object-fit:cover; display:block;">
      </div>
      <div class="section-pad" style="display:grid; gap:.35rem;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
          <strong>${esc(item.name)}</strong>
          <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
            ${item.abs === false ? '<span class="chip warn" title="This trim may not include ABS">No ABS</span>' : ''}
          </div>
        </div>
        <div class="subtitle">${esc(item.manufacturer)} • ${esc(item.category)}</div>
        <div style="font-size:.95rem;">${esc(perfLine(item))}</div>
        <ul style="margin:.25rem 0 0 1rem; padding:0; font-size:.95rem;">
          ${(item.reasons||[]).slice(0,3).map(r=>`<li>${esc(r)}</li>`).join('')}
        </ul>
        <div>
          <a id="${officialLinkId}" href="${item.official_url}" target="_blank" rel="noopener"
             class="btn btn-outline" style="display:inline-block; text-decoration:none; margin-top:.25rem;">Official Site</a>
        </div>
      </div>
    `;
    // Intercept official link for one-time MSRP popup
    setTimeout(()=>{
      const a = div.querySelector('#'+officialLinkId);
      if(a) a.addEventListener('click', (e)=>{
        if(sessionStorage.getItem('rr.msrpWarned') === '1') return; // allow
        e.preventDefault();
        pendingOfficialHref = a.href;
        openMsrp();
      });
    },0);
    return div;
  }

  function renderVisibleFromHistory(){
    const seen = new Set();
    const visible = [];
    const flat = [];
    const sorted = [...history].sort((a,b)=> (a.created_at < b.created_at ? 1 : -1));
    sorted.forEach(snap => snap.items.forEach(it => flat.push({snap, it})));
    flat.forEach(({it})=>{
      const key = it.id || it.bike_id || it.name;
      if(!seen.has(key)){
        seen.add(key);
        visible.push(it);
      }
    });

    visibleList.innerHTML = '';
    if(visible.length === 0){
      const p = document.createElement('p');
      p.className = 'subtitle';
      p.textContent = 'No saved recommendations yet. Click Re-run or use the Chat tab.';
      visibleList.appendChild(p);
      return;
    }
    visible.forEach(it => visibleList.appendChild(card(it)));
  }

  function renderTimeline(){
    timeline.innerHTML = '';
    const sorted = [...history].sort((a,b)=> (a.created_at < b.created_at ? 1 : -1));
    sorted.forEach(snap => {
      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.style.border = '1px solid var(--border)';
      const date = new Date(snap.created_at).toLocaleString();
      const inner = document.createElement('div');
      inner.innerHTML = `
        <div class="section-pad" style="border-bottom:1px solid var(--border); background:linear-gradient(180deg,#F3F4F6,#FFFFFF);">
          <strong>Snapshot • ${esc(date)}</strong>
          <div class="subtitle">${esc(summarize(snap.profile_used))}</div>
        </div>
      `;
      const grid = document.createElement('div');
      grid.className = 'section-pad';
      grid.style.display = 'grid';
      grid.style.gap = '1rem';
      snap.items.forEach(it => grid.appendChild(card(it)));
      wrap.appendChild(inner.firstElementChild);
      wrap.appendChild(grid);
      timeline.appendChild(wrap);
    });
  }

  function updateMeta(){
    profileSummary.textContent = summarize(profile);
    meta.textContent = `History: ${history.length} snapshot(s) • Latest-first view (de-duplicated)`;
  }

  // --------- API calls ---------
  async function callRecommend(){
    setSkeletons(profile.k || 3);
    const res = await fetch('/api/recommend', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(profile)
    });
    if(!res.ok){
      visibleList.innerHTML = '<p class="subtitle">Error fetching recommendations.</p>';
      return [];
    }
    const data = await res.json();
    return data.items || [];
  }

  async function chooseImage(item){
    try{
      const r = await fetch('/api/images', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ query: `${item.manufacturer} ${item.name}`, limit:1, mfr_domain: item.mfr_domain })
      });
      const j = await r.json();
      return (j.images && j.images[0] && j.images[0].url) || '/static/motorcyle_ride.jpg';
    }catch{
      return '/static/motorcyle_ride.jpg';
    }
  }

  async function createSnapshotFrom(items){
    const enriched = [];
    for(const it of items){
      const image_url = await chooseImage(it);
      enriched.push({
        id: it.id || it.name,
        name: it.name,
        manufacturer: it.manufacturer,
        category: it.category,
        engine_cc: it.engine_cc,
        seat_height_mm: it.seat_height_mm,
        wet_weight_kg: it.wet_weight_kg,
        abs: it.abs,
        // NEW: performance if present; otherwise undefined (renders as "-")
        max_speed_mph: it.max_speed_mph,
        zero_to_sixty_s: it.zero_to_sixty_s,
        reasons: it.reasons || [],
        official_url: it.official_url,
        mfr_domain: it.mfr_domain,
        image_url
      });
    }
    const snap = {
      id: 'rr-run-' + Date.now(),
      created_at: nowISO(),
      profile_used: {...profile},
      items: enriched
    };
    return snap;
  }

  // --------- Initial “style-first” shortlist preference (frontend) ---------
  function preferStyleCommon(items){
    // On very first snapshot of the session, bias to your curated style sets.
    if (hasRunOnce) return items;
    const types = (profile.bike_types||[]);
    const desiredOrder = [];
    if (types.length === 0){
      desiredOrder.push(...GLOBAL_COMMON);
    } else {
      // merge sets in the given order
      types.forEach(t=>{
        const ids = STYLE_COMMON[t] || [];
        ids.forEach(id=> desiredOrder.push(id));
      });
    }
    if (desiredOrder.length === 0) return items;

    const byId = new Map();
    items.forEach(it => byId.set(it.id || it.name, it));

    // Keep only those that appear in desiredOrder, preserving desired order; fill remainder if needed
    const preferred = desiredOrder.map(id => byId.get(id)).filter(Boolean);
    const remaining = items.filter(it => !desiredOrder.includes(it.id || it.name));
    const k = clamp(profile.k || 3, 1, 6);
    const result = preferred.slice(0, k);
    if (result.length < k){
      result.push(...remaining.slice(0, k - result.length));
    }
    return result;
  }

  async function runAndSave(){
    const raw = await callRecommend();
    const initial = preferStyleCommon(raw);
    const snap = await createSnapshotFrom(initial);
    history.unshift(snap);                    // newest-first
    history = history.slice(0, 10);          // cap snapshots
    writeJSON('rr.history', history);
    renderVisibleFromHistory();
    renderTimeline();
    updateMeta();
    // One-time ABS popup if any item lacks ABS (first snapshot only)
    if (!sessionStorage.getItem('rr.absWarned')) {
      const hasNoAbs = (snap.items||[]).some(it => it.abs === false);
      if (hasNoAbs) openAbs();
    }
    hasRunOnce = true;
  }

  // --------- Chat commands (prototype) ---------
  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = (chatInput.value || '').trim();
    if(!text) return;
    addBubble(text, 'user');
    chatInput.value = '';

    if(text.startsWith('/set')){
      const changed = applySet(text);
      writeJSON('rr.profile', profile);
      addBubble(changed.length ? ('Updated: ' + changed.join(', ')) : 'No changes detected.', 'bot');
    } else if(text.startsWith('/rec')){
      addBubble('Re-running recommendations…', 'bot');
      await runAndSave();
      addBubble('Done. New snapshot added at the top.', 'bot');
      switchTab('recs');
    } else {
      // Placeholder until OpenAI natural language is enabled (with topic filter)
      addBubble('Prototype chat: use /set height=175 budget=7000 types=naked and /rec. Natural language coming soon.', 'bot');
    }
  });

  function applySet(cmd){
    // /set height=175 budget=7000 exp=no_experience types=naked,sportbike k=3
    const parts = cmd.split(/\s+/).slice(1);
    const changed = [];
    parts.forEach(p=>{
      const [k,vRaw] = p.split('=');
      if(!k) return;
      const v = (vRaw||'').toLowerCase();
      if(['height','height_cm'].includes(k)){ profile.height_cm = clamp(parseInt(v||'170',10),140,210); changed.push(`height=${profile.height_cm}`); }
      else if(['budget','budget_usd'].includes(k)){ profile.budget_usd = clamp(parseInt(v||'6000',10),1000,20000); changed.push(`budget=$${profile.budget_usd}`); }
      else if(['exp','experience'].includes(k)){ profile.experience = (v==='little_experience'?'little_experience':'no_experience'); changed.push(`experience=${profile.experience}`); }
      else if(k==='types'){
        const arr = v.split(',').map(s=>s.trim()).filter(Boolean);
        const allow = new Set(["cruiser","standard","sportbike","naked","adventure","touring","dual_sport"]);
        profile.bike_types = arr.filter(x=>allow.has(x));
        changed.push(`types=${profile.bike_types.join(',')||'none'}`);
      }
      else if(k==='k'){ profile.k = clamp(parseInt(v||'3',10),1,6); changed.push(`k=${profile.k}`); }
    });
    return changed;
  }

  function addBubble(text, who){
    const div = document.createElement('div');
    div.className = 'bubble ' + (who === 'user' ? 'user' : 'bot');
    div.innerHTML = `<p>${esc(text)}</p><time>${ts()}</time>`;
    chatBody.appendChild(div);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // --------- Buttons ---------
  btnReRun.addEventListener('click', async ()=>{ await runAndSave(); });
  btnClearHistory.addEventListener('click', ()=>{
    history = [];
    writeJSON('rr.history', history);
    renderVisibleFromHistory();
    renderTimeline();
    updateMeta();
    // reset first-run flag so next run uses style-first again (optional; keep false to avoid loop)
  });

  // --------- One-time popups ---------
  function openBackdrop(){ backdrop.style.display='block'; }
  function closeBackdrop(){ backdrop.style.display='none'; }

  function openAbs(){ openBackdrop(); absModal.style.display='block'; }
  function closeAbs(){ absModal.style.display='none'; closeBackdrop(); sessionStorage.setItem('rr.absWarned','1'); }
  absOk.addEventListener('click', closeAbs);

  function openMsrp(){ openBackdrop(); msrpModal.style.display='block'; }
  function closeMsrp(){ msrpModal.style.display='none'; closeBackdrop(); }
  msrpCancel.addEventListener('click', ()=>{ pendingOfficialHref=null; closeMsrp(); });
  msrpProceed.addEventListener('click', ()=>{
    sessionStorage.setItem('rr.msrpWarned','1');
    const href = pendingOfficialHref; pendingOfficialHref = null;
    closeMsrp();
    if(href){ window.open(href, '_blank', 'noopener'); }
  });

  // --------- Init ---------
  (async function init(){
    writeJSON('rr.profile', profile); // ensure present
    updateMeta();
    // If no history yet, run once on entry (style-first bias)
    if(history.length === 0){
      await runAndSave();
    }else{
      renderVisibleFromHistory();
      renderTimeline();
    }
    switchTab('recs');
  })();
})();
</script>
{% endblock %}
